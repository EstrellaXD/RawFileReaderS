name: Release

on:
  push:
    tags: ["v*"]

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always

jobs:
  build-cli:
    name: CLI / ${{ matrix.target }}
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            runner: ubuntu-latest
            use-cross: true
            archive: tar.gz
          - target: aarch64-unknown-linux-gnu
            runner: ubuntu-latest
            use-cross: true
            archive: tar.gz
          - target: x86_64-apple-darwin
            runner: macos-14
            use-cross: false
            archive: tar.gz
          - target: aarch64-apple-darwin
            runner: macos-14
            use-cross: false
            archive: tar.gz
          - target: x86_64-pc-windows-msvc
            runner: windows-latest
            use-cross: false
            archive: zip

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Cache cargo registry & build
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: cli-${{ matrix.target }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: cli-${{ matrix.target }}-

      - name: Install cross
        if: matrix.use-cross
        run: cargo install cross --locked

      - name: Build CLI
        run: |
          ${{ matrix.use-cross && 'cross' || 'cargo' }} build \
            --release --target ${{ matrix.target }} -p thermo-raw-cli
        shell: bash

      - name: Prepare archive (unix)
        if: matrix.archive == 'tar.gz'
        run: |
          BIN="target/${{ matrix.target }}/release/thermo-raw-cli"
          cp "$BIN" thermo-raw
          tar czf thermo-raw-${{ matrix.target }}.tar.gz thermo-raw
        shell: bash

      - name: Prepare archive (windows)
        if: matrix.archive == 'zip'
        run: |
          cp "target/${{ matrix.target }}/release/thermo-raw-cli.exe" thermo-raw.exe
          7z a thermo-raw-${{ matrix.target }}.zip thermo-raw.exe
        shell: bash

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: cli-${{ matrix.target }}
          path: thermo-raw-${{ matrix.target }}.${{ matrix.archive }}
          if-no-files-found: error

  build-wheels:
    name: Wheels / ${{ matrix.os }} (${{ matrix.target }})
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: linux-x86_64
            runner: ubuntu-latest
            target: x86_64
          - os: linux-aarch64
            runner: ubuntu-latest
            target: aarch64
          - os: macos-x86_64
            runner: macos-14
            target: x86_64
            rust-target: x86_64-apple-darwin
          - os: macos-aarch64
            runner: macos-14
            target: aarch64
          - os: windows-x64
            runner: windows-latest
            target: x64

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        if: runner.os != 'Linux'
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Set up QEMU
        if: matrix.target == 'aarch64' && runner.os == 'Linux'
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Build wheels (Linux)
        if: runner.os == 'Linux'
        uses: PyO3/maturin-action@v1
        with:
          target: ${{ matrix.target }}
          args: --release --out dist --find-interpreter
          manylinux: auto
          working-directory: crates/thermo-raw-py

      - name: Install Rust toolchain
        if: runner.os != 'Linux'
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.rust-target || '' }}

      - name: Build wheels (macOS / Windows)
        if: runner.os != 'Linux'
        run: |
          pip install maturin
          cd crates/thermo-raw-py
          maturin build --release --out dist \
            --interpreter python3 \
            ${{ matrix.rust-target && format('--target {0}', matrix.rust-target) || '' }}
        shell: bash

      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-${{ matrix.os }}
          path: crates/thermo-raw-py/dist/*.whl
          if-no-files-found: error

  build-gui:
    name: GUI / ${{ matrix.target }}
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: aarch64-apple-darwin
            runner: macos-14
            archive: tar.gz
          - target: x86_64-apple-darwin
            runner: macos-14
            archive: tar.gz
          - target: x86_64-unknown-linux-gnu
            runner: ubuntu-latest
            archive: tar.gz
          - target: x86_64-pc-windows-msvc
            runner: windows-latest
            archive: zip

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install Linux system dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            gcc g++ clang libfontconfig-dev libwayland-dev \
            libwebkit2gtk-4.1-dev libxkbcommon-x11-dev libx11-xcb-dev \
            libssl-dev libzstd-dev \
            vulkan-validationlayers libvulkan1

      - name: Install cmake (Windows)
        if: runner.os == 'Windows'
        run: choco install cmake --installargs 'ADD_CMAKE_TO_PATH=System' -y

      - name: Cache cargo registry & build
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: gui-${{ matrix.target }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: gui-${{ matrix.target }}-

      - name: Build GUI
        run: |
          cargo build --release --target ${{ matrix.target }} -p thermo-raw-gui
        shell: bash

      - name: Prepare archive (unix)
        if: matrix.archive == 'tar.gz'
        run: |
          BIN="target/${{ matrix.target }}/release/thermo-raw-gui"
          cp "$BIN" thermo-raw-gui
          tar czf thermo-raw-gui-${{ matrix.target }}.tar.gz thermo-raw-gui
        shell: bash

      - name: Prepare archive (windows)
        if: matrix.archive == 'zip'
        run: |
          cp "target/${{ matrix.target }}/release/thermo-raw-gui.exe" thermo-raw-gui.exe
          7z a thermo-raw-gui-${{ matrix.target }}.zip thermo-raw-gui.exe
        shell: bash

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: gui-${{ matrix.target }}
          path: thermo-raw-gui-${{ matrix.target }}.${{ matrix.archive }}
          if-no-files-found: error

  release:
    name: GitHub Release
    needs: [build-cli, build-wheels, build-gui]
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Collect release assets
        run: |
          mkdir release-assets
          # CLI archives
          find artifacts/cli-* -type f \( -name '*.tar.gz' -o -name '*.zip' \) \
            -exec cp {} release-assets/ \;
          # GUI archives
          find artifacts/gui-* -type f \( -name '*.tar.gz' -o -name '*.zip' \) \
            -exec cp {} release-assets/ \;
          # Python wheels
          find artifacts/wheels-* -type f -name '*.whl' \
            -exec cp {} release-assets/ \;
          echo "Release assets:"
          ls -lh release-assets/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: release-assets/*
          generate_release_notes: true
          prerelease: ${{ contains(github.ref_name, '-beta') || contains(github.ref_name, '-rc') }}
